---
title: "Aoa_prediction_reliability"
output: html_document
---

### Script to measure reliability of CHILDES predictors, WordBank CDIs and regression models for target languages. 

Load libraries, define target languages, predictors and paths.
```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
options(dplyr.summarise.inform = FALSE)

library(tidyverse)
library(glue)
library(wordbankr)
#library(broom)
#install.packages("remotes")
#remotes::install_github("langcog/childesr")
library(childesr)
library(modelr)


walk(list.files("scripts", pattern = "*.R", full.names = TRUE), source)

target_langs <- c("Danish", "Norwegian", "Croatian", "English (American)", "Italian", "Spanish (Mexican)", "Turkish", "Swedish", "French (Quebecois)", "Russian")

predictor_list <- c("length_char","n_tokens", "mlu", "frequency", "solo_frequency", "first_frequency", "final_frequency")

childes_path <- "data/childes"

temp_path <- "data/temp_saved_data"

metric_funs <- list(compute_count, compute_mlu, compute_positions,
                    compute_length_char, compute_length_phon)
corpus_args <- list(corpus = NULL, role = NULL, role_exclude = "Target_Child",
                    age = NULL, sex = NULL, part_of_speech = NULL, token = "*")

```


### Functions CDI

* sbformula: adjusts correlation using the spearman-brown formula. https://assess.com/2018/04/14/what-is-the-spearman-brown-prediction-formula/

* measure_aoas: gets AoAs for CDI administrations using the get_aoas function

* split_wordbank: extracts WG and/or WS data from WordBank, and splits each form in random half. Then collapses forms.  

* get_main_rel_aoa: main wrapper function for CDI reliability, measures pearson correlation

```{r functions cdi}

# adjust with spearman-brown formula
sbformula <- function(r){
  if (!is.na(r)){
  r1<-(2*r)/(1+r)
  }else{
  r1=NA
  }
  return(r1)
}

#######################  


# measures aoa for each item
measure_aoas <- function(admin_summary) {
  d<- admin_summary |>
  mutate(num_false = total - num_true,
         prop = num_true / total) |>
  dplyr::select(language, measure, uni_lemma, prop, num_true,age, num_false, total, items) %>%
         unique()
  admin_aoas <- d|>
  group_by(language, measure) |>
  nest() |>
  mutate(aoa = map(data, get_aoas, max_steps = 400)) |>
  dplyr::select(-data) |>
  unnest(cols = c(aoa))
  return(admin_aoas)
}
################################



# get wordbank and randomly split in two
split_wordbank <- function(lang, form, meas){
  f <- file.path(temp_path, glue("{lang}_{form}.rds"))
  if(!file.exists(f)) {
  print(glue("Extract {lang} {form} data from WordBank"))
    items <- tryCatch({items <- create_inst_data(lang, form) %>%
      filter(measure==meas)
      }, error= function(e){})
    } else {
    print(glue("Load saved {lang} {form} data"))
    items <-readRDS(f)
  }
  if (length(unique(items$data_id)) >1){ #if at least 1 administration
   admin<-as.data.frame(unique(items$data_id))
   ind <- sample(c(TRUE, FALSE), nrow(admin), replace=TRUE, prob=c(0.5, 0.5))
   print(glue("Randomly split administrations..."))
   adminfirstnum <- admin[ind, ]
   adminfirst<-items %>% filter(data_id %in% adminfirstnum)
   adminfirst_summary <- collapse_inst_data(adminfirst)
   
   adminsecondnum <- admin[!ind, ] #create two groups of administrations
   adminsecond<-items %>% filter(data_id %in% adminsecondnum)
   adminsecond_summary <- collapse_inst_data(adminsecond)
   
   df <- list(adminfirst_summary, adminsecond_summary)
  } else{
   df<- NULL
  }
return(df)
}

#################  

# main function for reliabilities of aoa within wordbank
get_main_rel_aoa <-function(lang, meas){
  print(glue("Get CDI item data for {lang} {meas} and measure aoas..."))
  if (is.null(nrow(split_wordbank(lang, "WS", meas)[[1]]))){
     if (!is.null(nrow(split_wordbank(lang, "WG", meas)[[1]]))){
        first_aoas <- measure_aoas(split_wordbank(lang, "WG", meas)[[1]])
        second_aoas <-measure_aoas(split_wordbank(lang, "WG", meas)[[2]])
        r=cor(first_aoas$aoa, second_aoas$aoa, use="complete.obs", method="pearson")
     }else{
    r=NA
     }
  }
  else if (is.null(nrow(split_wordbank(lang, "WG", meas)[[1]]))){
    first_aoas <- measure_aoas(split_wordbank(lang, "WS", meas)[[1]])
    second_aoas <-measure_aoas(split_wordbank(lang, "WS", meas)[[2]])
    r=cor(first_aoas$aoa, second_aoas$aoa, use="complete.obs", method="pearson")
    } 
  else{   
  first_summary <- combine_form_data(list(split_wordbank(lang, "WS", meas)[[1]], split_wordbank(lang, "WG", meas)[[1]]))
  second_summary <- combine_form_data(list(split_wordbank(lang, "WS", meas)[[2]], split_wordbank(lang, "WG", meas)[[2]]))
  first_aoas <- measure_aoas(first_summary)
  second_aoas <-measure_aoas(second_summary)
  print(glue("Measure correlation ..."))
  r<-cor(first_aoas$aoa, second_aoas$aoa, use="complete.obs", method="pearson") #measure r
    }
  return(r)
}

```



### Measure reliabilities for aoa WordBank

Implement functions above, for each target language, measure (and optionally word_class). The mean correlation r is selected from 5 random splits of the administrations. 

```{r aoas, warning = FALSE, message=FALSE}

rel_aoa <- file.path(glue("data/reliabilities_aoa.rds")) #check whether cached data exist
  if(!file.exists(rel_aoa)) {
    
reliabilities_aoa <- expand_grid(lang = target_langs,
                                 meas = c("produces", "understands"),
                            word_class = c("all")) %>% # 
  rowwise %>%
  mutate(r_aoa = ifelse(is.na(get_main_rel_aoa(lang, meas)), NA, (sum(get_main_rel_aoa(lang, meas), get_main_rel_aoa(lang, meas), get_main_rel_aoa(lang, meas),get_main_rel_aoa(lang, meas),get_main_rel_aoa(lang, meas)))/5),
          sbr_aoa = sbformula(r_aoa))
  #mutate(split_half_aoa = ifelse(word_class == "all", 
  #                           split_half_cor_aoa(language, measure),
  #                           split_half_cor_aoa(language, word_class)),
        
  }else{
reliabilities_aoa <-  readRDS(rel_aoa)
}


pathrelaoa<- glue("data/reliabilities_aoa.rds")
saveRDS(reliabilities_aoa, pathrelaoa)
reliabilities_aoa %>%
  knitr::kable(digits = 2)

```
